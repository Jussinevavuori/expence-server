<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expence | Forgot password</title>
    <link rel="stylesheet" type="text/css" href="/styles/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body class="blue-grey darken-2 padding-sm">
    <div class="container padding-4">
      <div class="row center-align">
        <h3 class="white-text light">Expenceapp</h3>
      </div>
      <div class="row">
        <div class="col s12">
          <div class="card-panel hoverable">
            <div class="card-content">
              <!-- DONE MESSAGE -->
              <% if (locals.done) { %>

              <h4>Success</h4>
              <div>
                <section>
                  <p>Password succesfully reset</p>
                </section>

                <section>
                  <a
                    href="<%=locals.hosts.client%>/login"
                    class="btn waves-effect"
                    >Login</a
                  >
                </section>
              </div>

              <!-- RESET PASSWORD SCREEN -->
              <% } else if (locals.user) { %>

              <h4>Reset password</h4>
              <div>
                <section>
                  <p>Enter new password for <%= locals.user.email; %></p>
                </section>

                <section>
                  <form id="form">
                    <section class="input-field">
                      <label for="password">New password</label>
                      <input
                        class="input_outlined"
                        id="password"
                        type="password"
                        name="password"
                      />
                      <div>
                        <span id="password-error" class="red-text"></span>
                      </div>
                    </section>
                    <section class="input-field">
                      <label for="repeat">Repeat password</label>
                      <input id="repeat" type="password" name="repeat" />
                      <div>
                        <span id="repeat-error" class="red-text"></span>
                      </div>
                    </section>
                    <section>
                      <button
                        class="btn waves-effect"
                        type="submit"
                        name="action"
                      >
                        Reset password
                      </button>
                      <p id="form-error" class="red-text"></p>
                    </section>
                  </form>
                </section>
              </div>

              <!-- INVALID OR EXPIRED TOKEN -->
              <% } else { %>
              <p class="red-text">
                Invalid, used or expired reset password link.
              </p>

              <section>
                <a
                  href="<%=locals.hosts.client%>/login"
                  class="btn waves-effect"
                  >Back
                </a>
              </section>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Form handler -->
    <% if (locals.user) { %>
    <script>
      /**
       *	Handle password reset
       */
      var form = document.getElementById("form");

      var errors = {
        password: document.getElementById("password-error"),
        repeat: document.getElementById("repeat-error"),
        form: document.getElementById("form-error"),
      };

      function error(target, value) {
        errors[target].innerText = value;
      }

      error("password", "");
      error("repeat", "");
      error("form", "");

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        const password = e.target.password.value;
        const repeat = e.target.repeat.value;

        if (password.length < 5) {
          return error(
            "password",
            "Password must contain at the least 5 characters"
          );
        }

        if (password.length > 255) {
          return error(
            "password",
            "Password cannot be longer than 255 characters"
          );
        }

        if (repeat !== password) {
          return error("repeat", "Passwords do not match");
        }

        fetch(window.location.href, {
          method: "POST",
          headers: { ["Content-Type"]: "application/json" },
          body: JSON.stringify({ password }),
        })
          .then((response) => {
            console.log(response);
            if (response.status === 200) {
              window.location.href = "/forgot_password/done";
            } else {
              return response.json();
            }
          })
          .then((json) => {
            console.log(json);
            error("form", json.message);
          });
      });
    </script>
    <% } %>
  </body>
</html>
